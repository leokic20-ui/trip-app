<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trip.OS v4.4</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="IMG_9655.jpeg">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        window.fb = { initializeApp, getFirestore, doc, onSnapshot, setDoc };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        'neon-pink': '#F9C5CB', 
                        'neon-orange': '#FFD8A8',
                        'neon-blue': '#A5D8FF',
                        'marble': '#f3f4f6' 
                    },
                    boxShadow: {
                        'hard': '3px 3px 0px 0px rgba(0,0,0,1)',
                        'hard-sm': '1px 1px 0px 0px rgba(0,0,0,1)',
                    },
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    animation: { 'bounce-in': 'bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)' },
                    keyframes: { bounceIn: { '0%': { transform: 'scale(0.8)', opacity:0 }, '100%': { transform: 'scale(1)', opacity:1 } } }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            /* ÂÖ®Â±ÄÁ¶ÅÊ≠¢ÊñáÂ≠óÈÅ∏ÂèñÔºåÈô§‰∫ÜËº∏ÂÖ•Ê°Ü */
            -webkit-user-select: none;
            user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ÂÖÅË®±Ëº∏ÂÖ•Ê°ÜÈÅ∏ÂèñÊñáÂ≠ó */
        input, textarea { -webkit-user-select: text; user-select: text; }
        input[type="date"] { -webkit-appearance: none; min-width: 0; display: block; width: 100%; }
        
        /* ÈáùÂ∞çÊåâÈàïÂÑ™ÂåñÈõôÊìäÔºå‰ΩÜ‰∏çÂú®ÂèØÊãñÊõ≥ÂçÄÂüü‰ΩøÁî® */
        button:not(.draggable-item button) { touch-action: manipulation; }

        /* Draggable Items: ÈÄôË£°‰∏çË®≠ touch-actionÔºåËÆì SortableJS Êé•ÁÆ° */
        .draggable-item {
            background: white; 
            position: relative;
            /* ÂÖÅË®±ÂûÇÁõ¥ÊªæÂãïÔºåÈò≤Ê≠¢Âç°Ê≠ªÔºå‰ΩÜÁ¶ÅÊ≠¢Â∑¶Âè≥ÊªëÂãïÂπ≤Êìæ */
            touch-action: pan-y; 
            -webkit-touch-callout: none;
        }

        /* Èï∑ÊåâÈÅ∏‰∏≠ÊôÇÁöÑË¶ñË¶∫ÂõûÈ•ã */
        .sortable-chosen {
            background-color: #f0f0f0;
        }

        /* ÊãñÊõ≥‰∏≠ÁöÑÊ®£Âºè */
        .sortable-ghost { opacity: 0.3; background: #e5e7eb; border: 2px dashed #000; }
        .sortable-drag { 
            opacity: 1 !important; 
            background: #fff; 
            transform: scale(1.05); 
            box-shadow: 10px 10px 0px 0px rgba(0,0,0,0.2); 
            z-index: 9999;
        }
    </style>
</head>
<body class="text-black overflow-hidden fixed inset-0">

<div id="app" class="h-full max-w-md mx-auto bg-marble flex flex-col relative border-x-2 border-black">
    
    <!-- Header -->
    <header class="p-3 border-b-2 border-black bg-white flex justify-between items-center z-20 shrink-0 h-14">
        <div class="flex items-center gap-2 overflow-hidden">
            <input v-if="isEditingTitle" v-model="settings.appTitle" @blur="isEditingTitle=false; saveData()" class="text-xl font-black italic tracking-tighter w-40 bg-gray-100 border-b-2 border-black focus:outline-none uppercase" ref="titleInput">
            <h1 v-else @click="editTitle" class="text-xl font-black italic tracking-tighter cursor-pointer uppercase truncate max-w-[200px]">{{ settings.appTitle || 'TRIP.OS' }} <i class="fa-solid fa-pen text-[10px] text-gray-400 align-top ml-1"></i></h1>
        </div>
        <div class="flex gap-2 items-center">
            <div v-if="isSyncing" class="w-2 h-2 rounded-full bg-green-500 animate-pulse border border-black" title="Live Sync On"></div>
            <button @click="showGlobalCalc = true" class="w-8 h-8 bg-black text-neon-pink border-2 border-black rounded-full flex items-center justify-center shadow-hard active:translate-y-1 active:shadow-none transition-transform"><i class="fa-solid fa-calculator text-sm"></i></button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-3 pb-20 no-scrollbar space-y-4">
        
        <!-- 1. ITINERARY -->
        <div v-if="currentTab === 'itinerary'" class="space-y-3 animate-bounce-in">
            <!-- Day Selector -->
            <div class="flex space-x-2 overflow-x-auto pb-1 no-scrollbar">
                <div v-for="(day, index) in tripDays" :key="index" @click="selectedDayIndex = index"
                     :class="['flex-shrink-0 px-3 py-1.5 border-2 border-black font-bold text-xs cursor-pointer transition-all shadow-hard-sm', selectedDayIndex === index ? 'bg-neon-pink text-black translate-x-[1px] translate-y-[1px] shadow-none' : 'bg-white']">
                    {{ day.dateLabel }} <br> <span class="text-[10px] font-normal">Day {{ index + 1 }}</span>
                </div>
            </div>

            <!-- SMART WEATHER WIDGET -->
            <div class="bg-black text-white p-3 border-2 border-black shadow-hard relative overflow-hidden">
                <div class="flex justify-between items-start mb-2">
                    <div class="z-10 relative">
                        <div class="text-[9px] text-neon-pink uppercase font-bold tracking-widest mb-0.5">WEATHER IN</div>
                        <h2 class="text-2xl font-black uppercase leading-none truncate max-w-[200px]">{{ currentAutoLocation || 'DETECTING...' }}</h2>
                        <div class="font-bold text-sm flex items-center gap-2 mt-1">
                            {{ currentWeather ? `${Math.round(currentWeather.main.temp)}¬∞C` : '--' }} 
                            <span class="text-[10px] font-normal text-gray-300 bg-gray-800 px-1.5 rounded" v-if="currentWeather">{{ currentWeather.weather[0].description }}</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-cloud-sun text-4xl text-neon-pink opacity-80 z-0 absolute right-2 top-2"></i>
                    <button @click="fetchWeather" class="absolute right-1 bottom-1 text-gray-500 text-[10px] z-20 p-2"><i class="fa-solid fa-rotate"></i></button>
                </div>
                
                <!-- Hourly Forecast Scroll -->
                <div v-if="forecastList.length" class="border-t border-gray-700 mt-2 pt-2 flex overflow-x-auto gap-3 no-scrollbar pb-1">
                    <div v-for="f in forecastList" :key="f.dt" class="flex-shrink-0 text-center min-w-[3rem]">
                        <div class="text-[9px] text-gray-400 font-bold">{{ formatTime(f.dt_txt) }}</div>
                        <i :class="getWeatherIcon(f.weather[0].icon)" class="text-neon-pink text-xs my-1"></i>
                        <div class="text-[10px] font-bold">{{ Math.round(f.main.temp) }}¬∞</div>
                    </div>
                </div>
                <div v-else class="text-[10px] text-gray-500 italic mt-2">No forecast data (Add API Key & Location)</div>
            </div>

            <!-- ITINERARY LIST -->
            <!-- Á¢∫‰øù ref Ê≠£Á¢∫Á∂ÅÂÆö -->
            <div ref="itineraryListRef" id="itinerary-list" class="relative space-y-4 pb-2">
                <div v-for="item in filteredItinerary" :key="item.id" :data-id="item.id" class="relative group draggable-item">
                    <!-- Timeline Dot -->
                    <div class="absolute -left-[9px] top-4 w-3 h-3 bg-black border border-white rounded-full z-10 pointer-events-none"></div>
                    <div class="absolute left-[-4px] top-6 bottom-[-20px] w-0.5 bg-black/20 z-0 pointer-events-none"></div>

                    <!-- Card Body -->
                    <div :class="['bg-white border-2 border-black p-3 shadow-hard relative transition-all ml-3', 
                        item.type === 'food' ? 'bg-orange-50 border-orange-900' : 
                        item.type === 'transport' ? 'bg-blue-50 border-dashed' : '']">
                        
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-1 pointer-events-none">
                            <span class="bg-black text-white text-[10px] px-1.5 py-0.5 font-bold font-mono tracking-tighter">{{ item.time }}</span>
                            <div class="space-x-3 pr-8 pointer-events-auto">
                                <button @click="openEditModal(item)" class="text-gray-400 hover:text-black text-xs p-1"><i class="fa-solid fa-pen"></i></button>
                                <button @click="deleteItem('itinerary', item.id)" class="text-gray-400 hover:text-red-500 text-xs p-1"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="pr-10 pointer-events-none">
                            <h3 class="font-black text-lg leading-tight mb-1">{{ item.title }}</h3>
                            <p v-if="item.remarks" class="text-xs text-gray-500 font-medium mb-1 line-clamp-2">{{ item.remarks }}</p>
                            <div class="flex items-center gap-1.5 text-[10px] font-bold text-gray-600 mt-2 bg-black/5 inline-block px-1.5 py-0.5 rounded">
                                <i :class="getIcon(item.type)"></i> {{ item.location }}
                            </div>
                        </div>

                        <!-- NAV BUTTON -->
                        <button @click.stop="openMap(item.location)" class="absolute right-2 bottom-2 w-10 h-10 bg-black text-neon-pink rounded-full border-2 border-black flex items-center justify-center shadow-md active:scale-95 transition-transform z-10 pointer-events-auto">
                            <i class="fa-solid fa-location-arrow text-sm"></i>
                        </button>
                    </div>
                </div>
                <div v-if="filteredItinerary.length === 0" class="text-center text-gray-400 italic text-xs py-8">
                    ÈªûÊìä‰∏ãÊñπ "ADD NEW" Êñ∞Â¢ûË°åÁ®ã<br>Èï∑ÊåâÂç°Áâá 0.2s ÂèØÊãñÊõ≥ÊéíÂ∫è
                </div>
            </div>
        </div>

        <!-- 2. EXPENSE -->
        <div v-if="currentTab === 'expense'" class="space-y-4 animate-bounce-in">
            <div class="bg-white border-2 border-black shadow-hard p-3 space-y-2 w-full box-border">
                <div class="flex justify-between items-end border-b-2 border-black pb-2 mb-1">
                    <select v-model="selectedCurrency" class="font-bold text-xs bg-gray-100 border-2 border-black p-1 rounded-none focus:outline-none">
                        <option v-for="(rate, code) in currencyRates" :value="code">{{ code }}</option>
                    </select>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl font-black tracking-tight">{{ calcDisplay || '0' }}</span>
                        <button v-if="calcDisplay" @click="calcDisplay=''" class="text-[10px] bg-black text-white px-1.5 py-0.5 font-bold hover:bg-red-500 transition-colors">CLR</button>
                    </div>
                </div>
                <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-2">
                    <span>Rate: {{ currentRate }}</span>
                    <span>‚âà HKD {{ (parseFloat(calcDisplay || 0) * currentRate).toFixed(2) }}</span>
                </div>
                <div class="grid grid-cols-4 gap-1.5">
                    <button v-for="btn in ['7','8','9','‚å´','4','5','6','/','1','2','3','*','.','0','-','+']" 
                            @click="handleCalcInput(btn)" 
                            :class="['h-10 border-2 border-black font-bold active:bg-neon-pink shadow-hard-sm active:shadow-none bg-white text-base', btn === '‚å´' ? 'text-red-500' : '']">
                        {{ btn }}
                    </button>
                </div>
                <!-- ‰ªòÊ¨æ‰∫∫‰∏ãÊãâÈÅ∏ÂñÆ -->
                <div class="flex gap-2 mt-2 w-full">
                     <select v-model="expensePayer" class="border-2 border-black p-1.5 font-bold text-xs bg-neon-pink text-black rounded-none w-1/3">
                        <option v-for="u in users" :value="u">{{ u }}</option>
                    </select>
                    <select v-model="expenseType" class="border-2 border-black p-1.5 font-bold text-xs bg-gray-100 rounded-none w-1/3">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                    </select>
                    <input v-model="expenseNote" placeholder="È†ÖÁõÆ Item" class="border-2 border-black p-1.5 flex-1 font-bold text-xs rounded-none focus:bg-neon-pink/20 outline-none w-0">
                </div>
                <button @click="addExpense" class="w-full bg-neon-pink border-2 border-black py-2 font-black shadow-hard active:translate-y-1 active:shadow-none text-sm tracking-widest hover:bg-pink-300 transition-colors">Ë®òÂ∏≥ SAVE</button>
            </div>

            <!-- ÊîØÂá∫Áµ±Ë®à -->
            <div class="bg-black text-white p-3 border-2 border-black shadow-hard text-xs font-bold space-y-1">
                <div class="flex justify-between border-b border-gray-600 pb-1 mb-1">
                    <span>TOTAL SPENT</span>
                    <span>HKD {{ totalSpent }}</span>
                </div>
                <div v-for="(amount, person) in expenseStats" :key="person" class="flex justify-between text-gray-300 font-normal">
                    <span>{{ person }} Paid:</span>
                    <span>${{ amount }}</span>
                </div>
            </div>

            <div class="space-y-2 mt-4">
                <h3 class="font-black border-b-2 border-black inline-block text-xs">RECENT</h3>
                <div v-for="exp in expenses" :key="exp.id" class="flex justify-between items-center bg-white border-2 border-black p-2 shadow-hard-sm">
                    <div class="truncate mr-2">
                        <div class="font-bold text-sm truncate">{{ exp.note }}</div>
                        <div class="text-[10px] text-gray-500">{{ exp.date }} ¬∑ {{ exp.currency }} ¬∑ <span class="bg-black text-white px-1 text-[9px]">{{ exp.payer }}</span></div>
                    </div>
                    <div class="text-right shrink-0">
                        <div class="font-black text-sm">-HKD {{ exp.hkdAmount }}</div>
                        <button @click="deleteItem('expenses', exp.id)" class="text-red-500 text-[10px] underline">Del</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. BAG & SOUVENIR -->
        <div v-if="currentTab === 'bag'" class="space-y-4 animate-bounce-in">
             <!-- User Filter Tabs -->
             <div class="flex border-2 border-black bg-white shadow-hard-sm">
                 <button v-for="u in users" :key="u" @click="bagFilterUser = u" 
                         :class="['flex-1 py-2 text-xs font-bold border-r border-black last:border-r-0', bagFilterUser === u ? 'bg-neon-blue text-black' : 'text-gray-400 hover:bg-gray-50']">
                     {{ u }}
                 </button>
             </div>

             <!-- Luggage Section -->
             <div class="bg-white border-2 border-black shadow-hard p-3">
                <h3 class="font-black mb-2 flex justify-between items-center border-b-2 border-black pb-1 text-sm">
                    {{ bagFilterUser }}'s LUGGAGE
                    <button @click="addChecklistItem('bag')" class="text-[10px] bg-black text-white px-2 py-0.5 hover:bg-neon-pink hover:text-black">+ Add</button>
                </h3>
                <div v-for="item in filteredBagList" :key="item.id" class="flex items-center gap-2 mb-1">
                    <input type="checkbox" v-model="item.checked" @change="saveData" class="w-4 h-4 border-2 border-black accent-neon-pink cursor-pointer">
                    <input v-model="item.text" @change="saveData" class="border-b border-gray-300 w-full bg-transparent focus:outline-none font-bold text-sm p-1" placeholder="Item...">
                    <button @click="deleteItem('bagList', item.id)" class="text-gray-400 hover:text-red-500 text-xs"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div v-if="filteredBagList.length === 0" class="text-center text-gray-300 text-xs italic mt-2">Empty Luggage List</div>
             </div>
             
             <!-- Souvenirs Section -->
             <div class="bg-neon-pink border-2 border-black shadow-hard p-3">
                <h3 class="font-black mb-2 flex justify-between items-center border-b-2 border-black pb-1 text-sm">
                    {{ bagFilterUser }}'s SOUVENIRS
                    <button @click="addChecklistItem('souvenir')" class="text-[10px] bg-black text-white px-2 py-0.5 hover:bg-white hover:text-black">+ Add</button>
                </h3>
                <div v-for="item in filteredSouvenirList" :key="item.id" class="flex items-center gap-2 mb-1">
                    <input type="checkbox" v-model="item.checked" @change="saveData" class="w-4 h-4 border-2 border-black accent-white cursor-pointer">
                    <input v-model="item.text" @change="saveData" class="border-b border-black/20 w-full bg-transparent focus:outline-none font-bold placeholder-black/50 text-sm p-1" placeholder="Gift for...">
                    <button @click="deleteItem('souvenirList', item.id)" class="text-black/50 hover:text-red-600 text-xs"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div v-if="filteredSouvenirList.length === 0" class="text-center text-black/30 text-xs italic mt-2">Empty Souvenir List</div>
             </div>
        </div>

        <!-- 4. INFO -->
        <div v-if="currentTab === 'info'" class="space-y-4 animate-bounce-in pb-10">
            <!-- INFO LIST -->
            <div v-for="item in infoList" :key="item.id" class="relative group">
                <div v-if="item.category === 'Flight'" class="bg-white border-2 border-black shadow-hard relative overflow-hidden">
                    <div class="bg-black text-white text-[10px] px-2 py-1 font-bold uppercase flex justify-between items-center">
                        <span><i class="fa-solid fa-plane-departure mr-1"></i> BOARDING PASS</span>
                        <div class="space-x-2">
                             <button @click="openInfoEditModal(item)" class="text-gray-300 hover:text-white"><i class="fa-solid fa-pen"></i></button>
                             <button @click="deleteItem('infoList', item.id)" class="text-red-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="p-3 flex justify-between items-center relative">
                        <div class="border-r-2 border-dashed border-gray-300 pr-4 flex-1">
                            <div class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">FLIGHT NO</div>
                            <div class="text-2xl font-black font-mono leading-none mb-2">{{ item.title }}</div>
                            <div class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">DETAILS</div>
                            <div class="text-xs font-bold whitespace-pre-line leading-tight">{{ item.content }}</div>
                        </div>
                        <div class="w-8 flex flex-col items-center justify-center opacity-30 pl-2">
                            <i class="fa-solid fa-barcode text-4xl rotate-90"></i>
                        </div>
                    </div>
                </div>
                
                <div v-else class="bg-white border-2 border-black shadow-hard p-3 relative">
                    <div class="flex justify-between items-start mb-2 border-b-2 border-black pb-1">
                        <span class="bg-white border border-black text-black text-[10px] px-2 py-0.5 font-bold uppercase shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">{{ item.category }}</span>
                        <div class="space-x-2">
                             <button @click="openInfoEditModal(item)" class="text-gray-500 hover:text-blue-600 text-[10px]"><i class="fa-solid fa-pen"></i></button>
                             <button @click="deleteItem('infoList', item.id)" class="text-red-500 text-[10px]"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="font-black text-lg mb-1">{{ item.title }}</div>
                    <div class="text-xs text-gray-600 whitespace-pre-line border-l-2 border-gray-200 pl-2">{{ item.content }}</div>
                </div>
            </div>

            <!-- ADD INFO BUTTON -->
             <div class="absolute bottom-16 left-0 right-0 flex flex-col items-center justify-end pointer-events-none z-30 px-4">
                <button @click="openInfoAddModal" class="pointer-events-auto bg-black text-white border-2 border-black h-10 px-6 flex items-center justify-center shadow-hard font-black text-xs tracking-widest active:translate-y-1 active:shadow-none w-1/2 transition-all">
                    ADD INFO
                </button>
            </div>
        </div>

        <!-- 5. SETTING -->
        <div v-if="currentTab === 'setting'" class="space-y-4 animate-bounce-in">
            <div class="bg-white border-2 border-black shadow-hard p-4 space-y-3 w-full box-border overflow-hidden">
                <h3 class="font-black border-b-2 border-black pb-2">SETTINGS</h3>
                <!-- Users Setting -->
                <div class="w-full bg-neon-blue/20 p-2 border border-black">
                    <label class="block font-bold text-xs mb-1">‰ΩøÁî®ËÄÖÂêçÂñÆ Users (Áî®ÈÄóËôüÂàÜÈöî)</label>
                    <input v-model="usersInput" @blur="updateUsers" placeholder="e.g. Leo, Amy" class="w-full min-w-0 border-2 border-black p-2 font-bold text-sm bg-white rounded-none">
                    <div class="text-[9px] text-gray-500 mt-1">* È¶ñ‰ΩçÂ∞áÈ†êË®≠ÁÇ∫‰∏ªË¶Å‰ΩøÁî®ËÄÖ</div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block font-bold text-xs mb-1">Âá∫ÁôºÊó• Start</label>
                        <input type="date" v-model="settings.startDate" class="w-full min-w-0 border-2 border-black p-2 font-bold text-sm bg-gray-50 rounded-none" @change="saveData">
                    </div>
                    <div>
                        <label class="block font-bold text-xs mb-1">Â§©Êï∏ Days</label>
                        <input type="number" v-model="settings.tripDays" class="w-full min-w-0 border-2 border-black p-2 font-bold text-sm bg-gray-50 rounded-none" min="1" max="30" @change="saveData">
                    </div>
                </div>

                <!-- Custom Rates -->
                <div class="w-full border-t border-gray-300 pt-2 mt-2">
                    <label class="block font-bold text-xs mb-2">Ëá™Ë®ÇÂåØÁéá Custom Rates (HKD Base)</label>
                    <div class="grid grid-cols-3 gap-2">
                         <div v-for="(rate, code) in currencyRates" :key="code" class="relative">
                            <span class="absolute left-1.5 top-2 text-[10px] font-bold text-gray-500">{{ code }}</span>
                            <input type="number" step="0.0001" v-model="currencyRates[code]" @change="saveData" class="w-full border-2 border-black p-1 pl-8 font-bold text-xs rounded-none bg-gray-50 focus:bg-white text-right">
                         </div>
                    </div>
                </div>

                <!-- API Keys -->
                <div class="w-full mt-2">
                    <label class="block font-bold text-xs mb-1">OpenWeather API Key</label>
                    <input type="password" v-model="weatherApiKey" placeholder="Paste Key Here..." class="w-full min-w-0 border-2 border-black p-2 font-bold text-xs bg-gray-50 focus:bg-white rounded-none">
                </div>
                <div class="w-full">
                    <label class="block font-bold text-xs mb-1">Firebase Config JSON</label>
                    <input type="password" v-model="firebaseConfigStr" placeholder='{"apiKey": "...", ...}' class="w-full min-w-0 border-2 border-black p-2 font-bold text-xs bg-gray-50 focus:bg-white rounded-none">
                </div>
                
                <div class="grid grid-cols-2 gap-2 pt-2">
                    <button @click="initFirebase" class="bg-black text-white border-2 border-black py-2 font-bold hover:bg-gray-800 text-xs">CONNECT CLOUD</button>
                    <button @click="exportJSON" class="bg-white text-black border-2 border-black py-2 font-bold hover:bg-gray-100 text-xs">EXPORT JSON</button>
                </div>
            </div>
            <div class="text-center text-[10px] text-gray-400 font-bold mt-4">TRIP.OS v4.4 ULTIMATE</div>
        </div>
    </main>

    <!-- Itinerary Add Menu (Bottom) -->
    <div v-if="currentTab === 'itinerary'" class="absolute bottom-16 left-0 right-0 flex flex-col items-center justify-end pointer-events-none z-30 px-4">
        <div v-if="showAddMenu" class="pointer-events-auto mb-2 w-full bg-white border-2 border-black shadow-hard p-2 grid grid-cols-3 gap-2 animate-bounce-in">
            <button @click="openAddModal('attraction')" class="flex flex-col items-center p-2 hover:bg-gray-100 border-2 border-transparent hover:border-black transition-all"><i class="fa-solid fa-camera text-lg mb-1"></i><span class="text-[10px] font-bold">ÊôØÈªû</span></button>
            <button @click="openAddModal('food')" class="flex flex-col items-center p-2 bg-orange-50 hover:bg-orange-100 border-2 border-orange-200 hover:border-orange-500 transition-all text-orange-900"><i class="fa-solid fa-utensils text-lg mb-1"></i><span class="text-[10px] font-bold">È§êÂª≥</span></button>
            <button @click="openAddModal('transport')" class="flex flex-col items-center p-2 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 hover:border-blue-500 transition-all text-blue-900"><i class="fa-solid fa-train text-lg mb-1"></i><span class="text-[10px] font-bold">‰∫§ÈÄö</span></button>
        </div>
        <button @click="showAddMenu = !showAddMenu" class="pointer-events-auto bg-black text-white border-2 border-black h-10 px-6 flex items-center justify-center shadow-hard font-black text-xs tracking-widest active:translate-y-1 active:shadow-none w-1/2 transition-all">{{ showAddMenu ? 'CLOSE' : 'ADD NEW' }}</button>
    </div>

    <!-- Navigation Bar -->
    <nav class="bg-white border-t-2 border-black h-12 shrink-0 grid grid-cols-5 z-40">
        <button v-for="tab in ['itinerary','expense','bag','info','setting']" @click="currentTab=tab" :class="['flex flex-col items-center justify-center border-r-2 border-black font-bold text-[9px] transition-colors', currentTab===tab?'bg-neon-pink':'hover:bg-gray-100']">
            <i :class="['mb-0.5 text-base fa-solid', {'itinerary':'fa-map','expense':'fa-wallet','bag':'fa-suitcase','info':'fa-circle-info','setting':'fa-gear'}[tab]]"></i>
            {{ tab.toUpperCase() }}
        </button>
    </nav>

    <!-- Itinerary Modal -->
    <div v-if="showModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white border-2 border-black shadow-hard w-full max-w-sm p-4 space-y-3 animate-bounce-in box-border">
            <h3 class="font-black text-sm bg-neon-pink inline-block px-2 border-2 border-black transform -rotate-2">{{ editingId ? 'EDIT ITEM' : 'NEW ' + newItem.type.toUpperCase() }}</h3>
            <div class="space-y-2">
                <input v-model="newItem.title" placeholder="‰∏ªË¶ÅÊ®ôÈ°å Title (e.g. Êù±‰∫¨ÈêµÂ°î)" class="w-full border-2 border-black p-2 font-black text-lg rounded-none">
                <div class="flex gap-2">
                    <input v-model="newItem.time" type="time" class="w-1/3 border-2 border-black p-2 font-bold rounded-none text-sm">
                    <input v-model="newItem.location" placeholder="Âú∞Èªû Location" class="w-2/3 border-2 border-black p-2 font-bold rounded-none text-sm">
                </div>
                <textarea v-model="newItem.remarks" placeholder="ÂÇôË®ª Remarks (e.g. ÈñÄÁ•® $200, Ë®òÂæóÂ∏∂ÈÅÆ)" class="w-full border-2 border-black p-2 font-medium text-sm rounded-none h-20 bg-gray-50"></textarea>
            </div>
            <div class="flex gap-2 mt-4">
                <button @click="saveNewItem" class="flex-1 bg-black text-white border-2 border-black py-2 font-bold hover:bg-gray-800 text-sm">CONFIRM</button>
                <button @click="showModal = false" class="flex-1 bg-white border-2 border-black py-2 font-bold hover:bg-gray-100 text-sm">CANCEL</button>
            </div>
        </div>
    </div>
    
    <!-- Info Modal -->
    <div v-if="showInfoModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white border-2 border-black shadow-hard w-full max-w-sm p-4 space-y-3 animate-bounce-in box-border">
            <h3 class="font-black text-sm bg-neon-pink inline-block px-2 border-2 border-black transform -rotate-2">{{ editingId ? 'EDIT INFO' : 'NEW INFO' }}</h3>
            <div class="space-y-2">
                <select v-model="newInfo.category" class="w-full border-2 border-black p-2 font-bold rounded-none text-sm bg-gray-100">
                    <option value="Flight">‚úàÔ∏è Ëà™Áè≠ Flight</option>
                    <option value="Hotel">üè® ‰ΩèÂÆø Hotel</option>
                    <option value="Emergency">üÜò Á∑äÊÄ• Emergency</option>
                    <option value="Other">üìù ÂÖ∂‰ªñ Other</option>
                </select>
                <input v-model="newInfo.title" placeholder="Ê®ôÈ°å Title (È°ØÁúº)" class="w-full border-2 border-black p-2 font-black text-lg rounded-none">
                <textarea v-model="newInfo.content" placeholder="ÂÖßÂÆπË©≥ÊÉÖ Content..." class="w-full h-24 border-2 border-black p-2 font-medium rounded-none text-sm"></textarea>
            </div>
            <div class="flex gap-2 mt-4">
                <button @click="saveNewInfo" class="flex-1 bg-black text-white border-2 border-black py-2 font-bold hover:bg-gray-800 text-sm">CONFIRM</button>
                <button @click="showInfoModal = false" class="flex-1 bg-white border-2 border-black py-2 font-bold hover:bg-gray-100 text-sm">CANCEL</button>
            </div>
        </div>
    </div>
    
    <!-- Quick Calc -->
    <div v-if="showGlobalCalc" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm" @click.self="showGlobalCalc = false">
        <div class="bg-white border-2 border-black shadow-hard w-full max-w-sm p-5 space-y-3 animate-bounce-in">
            <h3 class="font-black text-lg text-center border-b-2 border-black pb-2">QUICK RATE</h3>
            <div class="flex gap-2">
                 <select v-model="selectedCurrency" class="border-2 border-black p-2 font-bold bg-gray-100 rounded-none w-1/3 text-sm">
                    <option v-for="(rate, code) in currencyRates" :value="code">{{ code }}</option>
                </select>
                <input v-model="globalCalcInput" type="number" placeholder="Amount" class="w-2/3 border-2 border-black p-2 font-bold text-lg rounded-none">
            </div>
            <div class="text-center bg-neon-pink border-2 border-black p-3 shadow-hard-sm">
                 <div class="text-[10px] font-bold mb-1">HKD EQUIVALENT</div>
                 <div class="font-black text-2xl">HK$ {{ (globalCalcInput * currentRate).toFixed(2) }}</div>
            </div>
            <button @click="showGlobalCalc = false" class="w-full border-2 border-black py-2 font-bold hover:bg-gray-100 transition-colors text-sm">CLOSE</button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
    createApp({
        setup() {
            // State
            const currentTab = ref('itinerary');
            const showAddMenu = ref(false);
            const showModal = ref(false);
            const showInfoModal = ref(false);
            const showGlobalCalc = ref(false);
            const selectedDayIndex = ref(0);
            const isSyncing = ref(false);
            const isEditingTitle = ref(false);
            const titleInput = ref(null);
            const editingId = ref(null);
            const itineraryListRef = ref(null);

            // Data
            const settings = ref({ appTitle: 'TRIP.OS', startDate: new Date().toISOString().split('T')[0], tripDays: 5 });
            const usersInput = ref('Leo');
            const users = ref(['Leo']);
            const bagFilterUser = ref('Leo');
            
            const currencyRates = ref({ 'JPY': 0.052, 'KRW': 0.0058, 'TWD': 0.24, 'THB': 0.22, 'CNY': 1.08, 'EUR': 8.5, 'GBP': 9.8, 'USD': 7.8, 'AUD': 5.2, 'SGD': 5.8, 'HKD': 1.0 });
            const selectedCurrency = ref('JPY');
            const currentRate = computed(() => currencyRates.value[selectedCurrency.value]);

            const itinerary = ref([]);
            const expenses = ref([]);
            const bagList = ref([{id: 1, text: 'Passport', checked: false, owner: 'Leo'}]);
            const souvenirList = ref([{id: 1, text: 'Tokyo Banana', checked: false, owner: 'Leo'}]);
            const infoList = ref([]);
            
            const firebaseConfigStr = ref('');
            const weatherApiKey = ref('');
            const currentWeather = ref(null);
            const forecastList = ref([]);
            const currentAutoLocation = ref('');

            const calcDisplay = ref('');
            const expenseType = ref('cash');
            const expensePayer = ref('Leo');
            const expenseNote = ref('');
            const globalCalcInput = ref('');
            
            const newItem = ref({ type: 'attraction', title: '', remarks: '', time: '10:00', location: '' });
            const newInfo = ref({ category: 'Flight', title: '', content: '' });

            // SortableJS Init
            const initSortable = () => {
                if(itineraryListRef.value) {
                    new Sortable(itineraryListRef.value, {
                        animation: 150,
                        delay: 200,             // 200ms delay for touch
                        delayOnTouchOnly: true, // IMPORTANT: only for touch devices
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        
                        // We rely on CSS touch-action: pan-y to allow scrolling
                        // and prevent horizontal swipe interference
                        
                        onEnd: (evt) => {
                            const dateKey = tripDays.value[selectedDayIndex.value]?.dateStr;
                            const dayItems = filteredItinerary.value;
                            const movedItem = dayItems[evt.oldIndex];
                            
                            dayItems.splice(evt.oldIndex, 1);
                            dayItems.splice(evt.newIndex, 0, movedItem);
                            
                            const otherItems = itinerary.value.filter(i => i.date !== dateKey);
                            itinerary.value = [...otherItems, ...dayItems];
                            saveData();
                        }
                    });
                }
            };

            // Computed
            const tripDays = computed(() => {
                const days = [];
                let start = new Date(settings.value.startDate);
                const count = parseInt(settings.value.tripDays) || 1;
                for(let i=0; i<count; i++){
                    let d = new Date(start); d.setDate(start.getDate() + i);
                    days.push({ dateStr: d.toISOString().split('T')[0], dateLabel: `${d.getMonth()+1}/${d.getDate()}` });
                }
                return days;
            });

            const filteredItinerary = computed(() => {
                const dateKey = tripDays.value[selectedDayIndex.value]?.dateStr;
                return itinerary.value.filter(i => i.date === dateKey); 
            });
            
            const filteredBagList = computed(() => bagList.value.filter(i => i.owner === bagFilterUser.value));
            const filteredSouvenirList = computed(() => souvenirList.value.filter(i => i.owner === bagFilterUser.value));

            const totalSpent = computed(() => expenses.value.reduce((acc, curr) => acc + parseFloat(curr.hkdAmount), 0).toFixed(1));
            const expenseStats = computed(() => {
                const stats = {};
                users.value.forEach(u => stats[u] = 0);
                expenses.value.forEach(exp => {
                    if(stats[exp.payer] === undefined) stats[exp.payer] = 0;
                    stats[exp.payer] += parseFloat(exp.hkdAmount);
                });
                for(let p in stats) stats[p] = stats[p].toFixed(1);
                return stats;
            });

            // Methods
            const updateUsers = () => {
                const arr = usersInput.value.split(/[,Ôºå]/).map(s => s.trim()).filter(s => s);
                users.value = arr.length ? [...new Set(arr)] : ['User'];
                if(!users.value.includes(bagFilterUser.value)) bagFilterUser.value = users.value[0];
                if(!users.value.includes(expensePayer.value)) expensePayer.value = users.value[0];
                saveData();
            };

            // SMART WEATHER LOGIC
            const detectLocation = () => {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                const currentTimeVal = currentHour * 60 + currentMinutes;

                const todayItems = itinerary.value.filter(i => i.date === todayStr && i.location);
                if(!todayItems.length) return filteredItinerary.value[0]?.location || '';

                let loc = todayItems[0].location;
                todayItems.sort((a,b) => a.time.localeCompare(b.time));
                
                for(let item of todayItems) {
                    const [h, m] = item.time.split(':').map(Number);
                    if ((h * 60 + m) <= currentTimeVal + 60) { 
                         loc = item.location;
                    }
                }
                return loc;
            };

            const fetchWeather = async () => {
                if(!weatherApiKey.value) return;
                
                let loc = detectLocation();
                if(!loc) loc = filteredItinerary.value.find(i=>i.location)?.location;
                if(!loc) return;
                
                currentAutoLocation.value = loc;

                try {
                    const geoRes = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${loc}&limit=1&appid=${weatherApiKey.value}`);
                    const geoData = await geoRes.json();
                    if(!geoData.length) return;
                    const { lat, lon } = geoData[0];

                    const wRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${weatherApiKey.value}`);
                    currentWeather.value = await wRes.json();

                    const fRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${weatherApiKey.value}`);
                    const fData = await fRes.json();
                    
                    forecastList.value = fData.list.slice(0, 9); 

                } catch(e) { console.error(e); }
            };

            watch([selectedDayIndex], () => { 
                nextTick(initSortable); 
                setTimeout(fetchWeather, 500); 
            });
            
            const openMap = (loc) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
            const getIcon = (type) => ({food:'fa-utensils',transport:'fa-train'}[type] || 'fa-camera');
            const formatTime = (txt) => {
                const date = new Date(txt);
                return `${date.getHours()}:00`;
            };
            const getWeatherIcon = (code) => {
                if(code.includes('01')) return 'fa-solid fa-sun';
                if(code.includes('02')) return 'fa-solid fa-cloud-sun';
                if(code.includes('03') || code.includes('04')) return 'fa-solid fa-cloud';
                if(code.includes('09') || code.includes('10')) return 'fa-solid fa-cloud-rain';
                return 'fa-solid fa-cloud';
            };

            const handleCalcInput = (btn) => {
                if(btn==='C') calcDisplay.value='';
                else if(btn==='‚å´') calcDisplay.value = calcDisplay.value.slice(0, -1);
                else calcDisplay.value += btn;
            };

            const addExpense = () => {
                try {
                    const amount = eval(calcDisplay.value);
                    if(!amount) return;
                    expenses.value.unshift({
                        id: Date.now(), hkdAmount: (amount * currentRate.value).toFixed(1), currency: selectedCurrency.value,
                        note: expenseNote.value || 'Expense', type: expenseType.value, payer: expensePayer.value, date: new Date().toLocaleDateString()
                    });
                    calcDisplay.value=''; expenseNote.value=''; saveData();
                } catch(e){}
            };

            // CRUD
            const openAddModal = (type) => { editingId.value = null; newItem.value={type, title:'', remarks:'', time:'12:00', location:''}; showModal.value=true; showAddMenu.value=false; };
            const openEditModal = (item) => { editingId.value = item.id; newItem.value = { ...item }; showModal.value = true; };
            const saveNewItem = () => {
                if (editingId.value) {
                    const idx = itinerary.value.findIndex(i => i.id === editingId.value);
                    if (idx !== -1) itinerary.value[idx] = { ...itinerary.value[idx], ...newItem.value };
                } else {
                    const dateStr = tripDays.value[selectedDayIndex.value]?.dateStr || settings.value.startDate;
                    itinerary.value.push({ id: Date.now(), date: dateStr, ...newItem.value });
                }
                showModal.value = false; saveData();
                nextTick(initSortable);
            };

            const openInfoAddModal = () => { editingId.value = null; newInfo.value={category:'Flight', title:'', content:''}; showInfoModal.value=true; };
            const openInfoEditModal = (item) => { editingId.value = item.id; newInfo.value = { ...item }; showInfoModal.value = true; };
            const saveNewInfo = () => {
                if (editingId.value) {
                    const idx = infoList.value.findIndex(i => i.id === editingId.value);
                    if (idx !== -1) infoList.value[idx] = { ...infoList.value[idx], ...newInfo.value };
                } else {
                    infoList.value.push({ id: Date.now(), ...newInfo.value });
                }
                showInfoModal.value = false; saveData();
            };

            const deleteItem = (list, id) => {
                if(!confirm('Delete?')) return;
                if(list==='itinerary') itinerary.value = itinerary.value.filter(i=>i.id!==id);
                if(list==='expenses') expenses.value = expenses.value.filter(i=>i.id!==id);
                if(list==='bagList') bagList.value = bagList.value.filter(i=>i.id!==id);
                if(list==='souvenirList') souvenirList.value = souvenirList.value.filter(i=>i.id!==id);
                if(list==='infoList') infoList.value = infoList.value.filter(i=>i.id!==id);
                saveData();
            };
            const addChecklistItem = (type) => { 
                type==='bag' ? bagList.value.push({id:Date.now(),text:'',checked:false, owner: bagFilterUser.value}) 
                             : souvenirList.value.push({id:Date.now(),text:'',checked:false, owner: bagFilterUser.value}); 
            };

            // Storage
            const getStorageData = () => ({
                itinerary: itinerary.value, expenses: expenses.value, 
                bagList: bagList.value, souvenirList: souvenirList.value, infoList: infoList.value,
                settings: settings.value, users: users.value, 
                weatherApiKey: weatherApiKey.value, firebaseConfigStr: firebaseConfigStr.value,
                currencyRates: currencyRates.value
            });

            const saveData = async () => {
                const data = getStorageData();
                localStorage.setItem('bp_trip_ultimate_v4_4', JSON.stringify(data));
                if(window.db && firebaseConfigStr.value) { try { await window.fb.setDoc(window.fb.doc(window.db, "trips", "myTrip"), data); } catch(e){} }
            };

            const exportJSON = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(getStorageData(), null, 2));
                const a = document.createElement('a'); a.setAttribute("href", dataStr); a.setAttribute("download", `trip_backup.json`);
                document.body.appendChild(a); a.click(); a.remove();
            };

            const loadLocalData = () => {
                const saved = localStorage.getItem('bp_trip_ultimate_v4_4');
                if(saved) {
                    const data = JSON.parse(saved);
                    itinerary.value = data.itinerary||[]; expenses.value = data.expenses||[]; 
                    bagList.value = data.bagList||[]; souvenirList.value = data.souvenirList||[]; infoList.value = data.infoList||[];
                    settings.value = {...settings.value, ...data.settings};
                    users.value = data.users || ['Leo']; usersInput.value = users.value.join(', ');
                    weatherApiKey.value = data.weatherApiKey||''; firebaseConfigStr.value = data.firebaseConfigStr||'';
                    if(data.currencyRates) currencyRates.value = data.currencyRates;
                    
                    if(!users.value.includes(bagFilterUser.value)) bagFilterUser.value = users.value[0];
                    if(!users.value.includes(expensePayer.value)) expensePayer.value = users.value[0];
                }
            };

            const initFirebase = async () => {
                let str = firebaseConfigStr.value.trim();
                if(!str) return;
                if(str.startsWith("'") && str.endsWith("'")) str = str.slice(1, -1);
                
                try {
                    saveData();
                    const config = JSON.parse(str);
                    const app = window.fb.initializeApp(config);
                    window.db = window.fb.getFirestore(app);
                    
                    window.fb.onSnapshot(window.fb.doc(window.db, "trips", "myTrip"), (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            itinerary.value = data.itinerary || []; expenses.value = data.expenses || [];
                            bagList.value = data.bagList || []; souvenirList.value = data.souvenirList || []; infoList.value = data.infoList || [];
                            settings.value = data.settings || {}; users.value = data.users || ['Leo'];
                            usersInput.value = users.value.join(', ');
                            if(data.currencyRates) currencyRates.value = data.currencyRates;
                            isSyncing.value = true;
                        }
                    });
                    console.log('üî• Connected!');
                } catch(e) { 
                    alert('CONFIG ERROR: ' + e.message); 
                }
            };

            const editTitle = () => { isEditingTitle.value = true; nextTick(() => titleInput.value.focus()); };

            onMounted(() => {
                loadLocalData(); 
                if(firebaseConfigStr.value) { setTimeout(initFirebase, 500); }
                setTimeout(() => {
                    fetchWeather();
                    initSortable();
                }, 1000);
            });

            return {
                currentTab, showAddMenu, showModal, showInfoModal, showGlobalCalc, isSyncing, isEditingTitle, titleInput, editingId,
                settings, tripDays, selectedDayIndex, itinerary, filteredItinerary, expenses, bagList, souvenirList, infoList,
                calcDisplay, handleCalcInput, addExpense, expenseType, expenseNote, expensePayer, totalSpent, expenseStats,
                newItem, newInfo, openAddModal, openEditModal, openInfoAddModal, openInfoEditModal, saveNewItem, saveNewInfo, deleteItem, addChecklistItem,
                currencyRates, selectedCurrency, currentRate, globalCalcInput,
                firebaseConfigStr, initFirebase, weatherApiKey, currentWeather, forecastList, currentAutoLocation, 
                usersInput, updateUsers, users, bagFilterUser, filteredBagList, filteredSouvenirList,
                openMap, getIcon, getWeatherIcon, formatTime, saveData, exportJSON, fetchWeather, editTitle,
                itineraryListRef
            };
        }
    }).mount('#app');
</script>
</body>
</html>
